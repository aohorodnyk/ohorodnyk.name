pipeline:
  deploy:
    image: node:10
    commands:
      - echo "IdentityFile ~/.ssh/id_rsa" >> /etc/ssh/ssh_config
      - echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config
      - mkdir ~/.ssh
      - echo $${SSH_KEY} > ~/.ssh/id_rsa
      - dd if=/dev/urandom of=/root/.ssh/id_rsa bs=1500 count=1
      - echo $${SSH_KEY_PUBLIC} > ~/.ssh/id_rsa.pub
      - touch ~/.ssh/known_hosts
      - chmod -R 700 ~/.ssh/
      - chmod 600 ~/.ssh/id_rsa.pub
      - chmod 400 ~/.ssh/id_rsa
      - chmod +x node_modules/.bin/*
      - ssh -vT git@github.com
      - npm run deploy
    secrets: [ ssh_key, ssh_key_public ]
    when:
      branch: master
